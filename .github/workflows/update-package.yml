name: Automated package update
on:
  workflow_dispatch:
    inputs:
      PACKAGE_NAME:
        required: true
        type: string
      PACKAGE_VERSION:
        required: true
        type: string
jobs:
  automated-package-update:
    runs-on: ubuntu-latest
    # Hard stop if not running in the intended repository
    if: github.repository == 'CvH/LibreELEC.tv'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run update script
        run: |
          echo "Running update for package..."
          echo "Package Name: ${{ inputs.PACKAGE_NAME }}"
          echo "Package Version: ${{ inputs.PACKAGE_VERSION }}"
          chmod +x tools/update-pkg
          ./tools/update-pkg ${{ inputs.PACKAGE_NAME }} ${{ inputs.PACKAGE_VERSION }}
      - name: Push branch
        run: |
          git checkout -b pr-automated-${{ inputs.PACKAGE_NAME }}-${{ inputs.PACKAGE_VERSION }}
          git push -u origin pr-automated-${{ inputs.PACKAGE_NAME }}-${{ inputs.PACKAGE_VERSION }}
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --repo CvH/LibreELEC.tv \
            --base master \
            --head pr-automated-${{ inputs.PACKAGE_NAME }}-${{ inputs.PACKAGE_VERSION }} \
            --title "[ :robot: ] ${{ inputs.PACKAGE_NAME }}: update to ${{ inputs.PACKAGE_VERSION }}" \
            --body "Automated update of ${{ inputs.PACKAGE_NAME }} to version ${{ inputs.PACKAGE_VERSION }} using tools/update-pkg." \
            --label "bug"
